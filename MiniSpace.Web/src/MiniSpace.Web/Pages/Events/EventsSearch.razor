@page "/events/search"
@using MiniSpace.Web.Areas.Identity
@using MiniSpace.Web.Areas.Events
@using MiniSpace.Web.Areas.Students
@using MiniSpace.Web.Components
@using MiniSpace.Web.DTO
@using MiniSpace.Web.DTO.Wrappers
@using MiniSpace.Web.Models.Events
@using MiniSpace.Web.Models.Organizations
@using MiniSpace.Web.Pages.Events.Dialogs
@using MudBlazor
@using Radzen
@using DialogOptions = Radzen.DialogOptions
@using DialogService = Radzen.DialogService
@using Orientation = Radzen.Orientation
@using System.Globalization
@using AlignItems = Radzen.AlignItems
@using Variant = Radzen.Variant
@inject DialogService DialogService
@inject IEventsService EventsService
@inject IStudentsService StudentsService
@inject NavigationManager NavigationManager

<h1 class="rz-p-8 search-font">Search events</h1>

<RadzenStack Gap="2rem" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
    <RadzenButton Text="Filter by criteria" Click="@OpenSearchDialog" Icon="pageview" class="separate-button rz-ml-5"/>
    <RadzenButton Text="All events" Click="@(() => value = 1)" class="@(value == 1 ? "separate-button hovered-button" : "separate-button")"/>
    <RadzenButton Text="My events" Click="@(() => value = 2)" class="@(value == 2 ? "separate-button hovered-button" : "separate-button")"/>
    <RadzenButton Text="Friends events" Click="@(() => value = 3)" class="@(value == 3 ? "separate-button hovered-button" : "separate-button")"/>
</RadzenStack>

@if (!pageInitialized)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <RadzenProgressBarCircular ShowValue="true" ProgressBarStyle="ProgressBarStyle.Light" 
                                   Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
            <Template>Loading...</Template>
        </RadzenProgressBarCircular>
    </div>
}

@if (pageInitialized && totalElements == 0)
{
    <h3 class="rz-p-12">No results found. Try to give us more general filtering criteria.</h3>
}

@if (pageInitialized && totalElements != 0)
{
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <MudPagination Count="@totalPages" SelectedChanged="@SelectedPageChanged"
                       Selected="@searchEventsModel.Pageable.Page"
                       Rectangular="true" ShowFirstButton="true" ShowLastButton="true"/>
    </RadzenStack>   
}

<div>
    <RadzenDataList AllowPaging="false" Data="@events" TItem="EventDto">
        <Template Context="ev">
            <RadzenEventCard Event="ev"/>
        </Template>
    </RadzenDataList>
</div>

@if (pageInitialized && totalElements != 0)
{
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
        <MudPagination Count="@totalPages" SelectedChanged="@SelectedPageChanged"
                       Selected="@searchEventsModel.Pageable.Page"
                       Rectangular="true" ShowFirstButton="true" ShowLastButton="true"/>
    </RadzenStack>   
}

<style>
    .search-font {
        font-family: Arial, sans-serif; /* Change this to your preferred font */
        font-size: 40px; /* Change this to your preferred font size */
        font-weight: bold; /* Change this to your preferred font weight */
    }
    
    .separate-button {
        margin: 10px; 
        background-color: #30445f !important; 
        border: 1px solid #ccc; 
        border-radius: 5px; 
        padding: 12px;
        color: #333; 
        transition: background-color 0.3s ease; 
    }
    
    .separate-button:hover {
        background-color: #30445f; 
        color: #000; 
    }
    
    .hovered-button {
        background-color: #ccc; /* Change this to your preferred hover color */
        color: #000; /* Change this to your preferred hover text color */
    }
    
</style>


@code {
    private SearchEventsModel searchEventsModel = new()
    {
        Name = "",
        Organizer = "",
        Organization = new OrganizationModel(),
        Category = "",
        State = "",
        Friends = [],
        FriendsEngagementType = "",
        DateFrom = DateTime.Now.AddDays(-7),
        DateTo = DateTime.Now.AddDays(30),
        Pageable = new PageableDto()
        {
            Page = 1,
            Size = 5,
            Sort = new SortDto()
            {
                SortBy = new List<string>(),
                Direction = "des"
            }
        }
    };
    
    private bool pageInitialized = false;
    private int value = 1;
    int totalPages = 0;
    int totalElements = 0;
    IEnumerable<EventDto> events;
    
    protected override async Task OnInitializedAsync()
    {
        var tmp = await EventsService.SearchEventsAsync(searchEventsModel.Name, searchEventsModel.Organizer,
            searchEventsModel.Organization.Id, searchEventsModel.Organization.RootId, searchEventsModel.Category,
            searchEventsModel.State, searchEventsModel.Friends, searchEventsModel.FriendsEngagementType,
            searchEventsModel.DateFrom.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ"),
            searchEventsModel.DateTo.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ"),
            searchEventsModel.Pageable);
        if (tmp.Content != null)
        {
            totalPages = tmp.Content.TotalPages;
            totalElements = tmp.Content.TotalElements;
            events = tmp.Content.Content;
        }
        else
        {
            totalPages = 0;
            totalElements = 0;
            events = new List<EventDto>();
        }

        pageInitialized = true;
    }
    
    private async void SelectedPageChanged(int pageNumber)
    {
        searchEventsModel.Pageable.Page = pageNumber;
        
        var tmp = await EventsService.SearchEventsAsync(searchEventsModel.Name, searchEventsModel.Organizer,
            searchEventsModel.Organization.Id, searchEventsModel.Organization.RootId, searchEventsModel.Category,
            searchEventsModel.State, searchEventsModel.Friends, searchEventsModel.FriendsEngagementType,
            searchEventsModel.DateFrom.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ"),
            searchEventsModel.DateTo.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ"),
            searchEventsModel.Pageable);
        events = tmp.Content.Content;
        StateHasChanged();
    }
    
    private async Task OpenSearchDialog()
    {
        await DialogService.OpenAsync<EventsSearchDialog>($"Filter all events by criteria:",
            new Dictionary<string, object>() { { "SearchEventsModel", searchEventsModel } },
            new DialogOptions()
            {
                Width = "800px", Height = "650px", Resizable = true, Draggable = true,
                AutoFocusFirstElement = false
            });
        await OnInitializedAsync();
    }
    
    
}
